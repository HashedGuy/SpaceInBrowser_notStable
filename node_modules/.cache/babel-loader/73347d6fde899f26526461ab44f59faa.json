{"ast":null,"code":"import _slicedToArray from \"/Users/arbus/Documents/SpaceInBrowser/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport _classCallCheck from \"/Users/arbus/Documents/SpaceInBrowser/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/arbus/Documents/SpaceInBrowser/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _inherits from \"/Users/arbus/Documents/SpaceInBrowser/node_modules/@babel/runtime/helpers/esm/inherits.js\";\nimport _createSuper from \"/Users/arbus/Documents/SpaceInBrowser/node_modules/@babel/runtime/helpers/esm/createSuper.js\";\nimport { Loader, FileLoader, MeshStandardMaterial, Color, TextureLoader, Object3D, Matrix4, BufferGeometryLoader, DirectionalLight, PointLight, RectAreaLight, Vector3, SpotLight, CanvasTexture, LinearFilter, ClampToEdgeWrapping, SpriteMaterial, Sprite, LineBasicMaterial, Line, Mesh, PointsMaterial, Points } from 'three';\n\nvar _taskCache = new WeakMap();\n\nvar Rhino3dmLoader = /*#__PURE__*/function (_Loader) {\n  _inherits(Rhino3dmLoader, _Loader);\n\n  var _super = _createSuper(Rhino3dmLoader);\n\n  function Rhino3dmLoader(manager) {\n    var _this;\n\n    _classCallCheck(this, Rhino3dmLoader);\n\n    _this = _super.call(this, manager);\n    _this.libraryPath = '';\n    _this.libraryPending = null;\n    _this.libraryBinary = null;\n    _this.libraryConfig = {};\n    _this.url = '';\n    _this.workerLimit = 4;\n    _this.workerPool = [];\n    _this.workerNextTaskID = 1;\n    _this.workerSourceURL = '';\n    _this.workerConfig = {};\n    _this.materials = [];\n    return _this;\n  }\n\n  _createClass(Rhino3dmLoader, [{\n    key: \"setLibraryPath\",\n    value: function setLibraryPath(path) {\n      this.libraryPath = path;\n      return this;\n    }\n  }, {\n    key: \"setWorkerLimit\",\n    value: function setWorkerLimit(workerLimit) {\n      this.workerLimit = workerLimit;\n      return this;\n    }\n  }, {\n    key: \"load\",\n    value: function load(url, onLoad, onProgress, onError) {\n      var _this2 = this;\n\n      var loader = new FileLoader(this.manager);\n      loader.setPath(this.path);\n      loader.setResponseType('arraybuffer');\n      loader.setRequestHeader(this.requestHeader);\n      this.url = url;\n      loader.load(url, function (buffer) {\n        // Check for an existing task using this buffer. A transferred buffer cannot be transferred\n        // again from this thread.\n        if (_taskCache.has(buffer)) {\n          var cachedTask = _taskCache.get(buffer);\n\n          return cachedTask.promise.then(onLoad).catch(onError);\n        }\n\n        _this2.decodeObjects(buffer, url).then(onLoad).catch(onError);\n      }, onProgress, onError);\n    }\n  }, {\n    key: \"debug\",\n    value: function debug() {\n      console.log('Task load: ', this.workerPool.map(function (worker) {\n        return worker._taskLoad;\n      }));\n    }\n  }, {\n    key: \"decodeObjects\",\n    value: function decodeObjects(buffer, url) {\n      var _this3 = this;\n\n      var worker;\n      var taskID;\n      var taskCost = buffer.byteLength;\n\n      var objectPending = this._getWorker(taskCost).then(function (_worker) {\n        worker = _worker;\n        taskID = _this3.workerNextTaskID++; //hmmm\n\n        return new Promise(function (resolve, reject) {\n          worker._callbacks[taskID] = {\n            resolve: resolve,\n            reject: reject\n          };\n          worker.postMessage({\n            type: 'decode',\n            id: taskID,\n            buffer: buffer\n          }, [buffer]); //this.debug();\n        });\n      }).then(function (message) {\n        return _this3._createGeometry(message.data);\n      }); // Remove task from the task list.\n      // Note: replaced '.finally()' with '.catch().then()' block - iOS 11 support (#19416)\n\n\n      objectPending.catch(function () {\n        return true;\n      }).then(function () {\n        if (worker && taskID) {\n          _this3._releaseTask(worker, taskID); //this.debug();\n\n        }\n      }); // Cache the task result.\n\n      _taskCache.set(buffer, {\n        url: url,\n        promise: objectPending\n      });\n\n      return objectPending;\n    }\n  }, {\n    key: \"parse\",\n    value: function parse(data, onLoad, onError) {\n      this.decodeObjects(data, '').then(onLoad).catch(onError);\n    }\n  }, {\n    key: \"_compareMaterials\",\n    value: function _compareMaterials(material) {\n      var mat = {};\n      mat.name = material.name;\n      mat.color = {};\n      mat.color.r = material.color.r;\n      mat.color.g = material.color.g;\n      mat.color.b = material.color.b;\n      mat.type = material.type;\n\n      for (var i = 0; i < this.materials.length; i++) {\n        var m = this.materials[i];\n        var _mat = {};\n        _mat.name = m.name;\n        _mat.color = {};\n        _mat.color.r = m.color.r;\n        _mat.color.g = m.color.g;\n        _mat.color.b = m.color.b;\n        _mat.type = m.type;\n\n        if (JSON.stringify(mat) === JSON.stringify(_mat)) {\n          return m;\n        }\n      }\n\n      this.materials.push(material);\n      return material;\n    }\n  }, {\n    key: \"_createMaterial\",\n    value: function _createMaterial(material) {\n      if (material === undefined) {\n        return new MeshStandardMaterial({\n          color: new Color(1, 1, 1),\n          metalness: 0.8,\n          name: 'default',\n          side: 2\n        });\n      }\n\n      var _diffuseColor = material.diffuseColor;\n      var diffusecolor = new Color(_diffuseColor.r / 255.0, _diffuseColor.g / 255.0, _diffuseColor.b / 255.0);\n\n      if (_diffuseColor.r === 0 && _diffuseColor.g === 0 && _diffuseColor.b === 0) {\n        diffusecolor.r = 1;\n        diffusecolor.g = 1;\n        diffusecolor.b = 1;\n      } // console.log( material );\n\n\n      var mat = new MeshStandardMaterial({\n        color: diffusecolor,\n        name: material.name,\n        side: 2,\n        transparent: material.transparency > 0 ? true : false,\n        opacity: 1.0 - material.transparency\n      });\n      var textureLoader = new TextureLoader();\n\n      for (var i = 0; i < material.textures.length; i++) {\n        var texture = material.textures[i];\n\n        if (texture.image !== null) {\n          var map = textureLoader.load(texture.image);\n\n          switch (texture.type) {\n            case 'Diffuse':\n              mat.map = map;\n              break;\n\n            case 'Bump':\n              mat.bumpMap = map;\n              break;\n\n            case 'Transparency':\n              mat.alphaMap = map;\n              mat.transparent = true;\n              break;\n\n            case 'Emap':\n              mat.envMap = map;\n              break;\n          }\n        }\n      }\n\n      return mat;\n    }\n  }, {\n    key: \"_createGeometry\",\n    value: function _createGeometry(data) {\n      // console.log(data);\n      var object = new Object3D();\n      var instanceDefinitionObjects = [];\n      var instanceDefinitions = [];\n      var instanceReferences = [];\n      object.userData['layers'] = data.layers;\n      object.userData['groups'] = data.groups;\n      object.userData['settings'] = data.settings;\n      object.userData['objectType'] = 'File3dm';\n      object.userData['materials'] = null;\n      object.name = this.url;\n      var objects = data.objects;\n      var materials = data.materials;\n\n      for (var i = 0; i < objects.length; i++) {\n        var obj = objects[i];\n        var attributes = obj.attributes;\n\n        switch (obj.objectType) {\n          case 'InstanceDefinition':\n            instanceDefinitions.push(obj);\n            break;\n\n          case 'InstanceReference':\n            instanceReferences.push(obj);\n            break;\n\n          default:\n            var _object = void 0;\n\n            if (attributes.materialIndex >= 0) {\n              var rMaterial = materials[attributes.materialIndex];\n\n              var material = this._createMaterial(rMaterial);\n\n              material = this._compareMaterials(material);\n              _object = this._createObject(obj, material);\n            } else {\n              var _material2 = this._createMaterial();\n\n              _object = this._createObject(obj, _material2);\n            }\n\n            if (_object === undefined) {\n              continue;\n            }\n\n            var layer = data.layers[attributes.layerIndex];\n            _object.visible = layer ? data.layers[attributes.layerIndex].visible : true;\n\n            if (attributes.isInstanceDefinitionObject) {\n              instanceDefinitionObjects.push(_object);\n            } else {\n              object.add(_object);\n            }\n\n            break;\n        }\n      }\n\n      for (var _i = 0; _i < instanceDefinitions.length; _i++) {\n        var iDef = instanceDefinitions[_i];\n        objects = [];\n\n        for (var j = 0; j < iDef.attributes.objectIds.length; j++) {\n          var objId = iDef.attributes.objectIds[j];\n\n          for (var p = 0; p < instanceDefinitionObjects.length; p++) {\n            var idoId = instanceDefinitionObjects[p].userData.attributes.id;\n\n            if (objId === idoId) {\n              objects.push(instanceDefinitionObjects[p]);\n            }\n          }\n        } // Currently clones geometry and does not take advantage of instancing\n\n\n        for (var _j = 0; _j < instanceReferences.length; _j++) {\n          var iRef = instanceReferences[_j];\n\n          if (iRef.geometry.parentIdefId === iDef.attributes.id) {\n            var iRefObject = new Object3D();\n            var xf = iRef.geometry.xform.array;\n            var matrix = new Matrix4();\n            matrix.set(xf[0], xf[1], xf[2], xf[3], xf[4], xf[5], xf[6], xf[7], xf[8], xf[9], xf[10], xf[11], xf[12], xf[13], xf[14], xf[15]);\n            iRefObject.applyMatrix4(matrix);\n\n            for (var _p = 0; _p < objects.length; _p++) {\n              iRefObject.add(objects[_p].clone(true));\n            }\n\n            object.add(iRefObject);\n          }\n        }\n      }\n\n      object.userData['materials'] = this.materials;\n      return object;\n    }\n  }, {\n    key: \"_createObject\",\n    value: function _createObject(obj, mat) {\n      var loader = new BufferGeometryLoader();\n      var attributes = obj.attributes;\n\n      var geometry, material, _color, color;\n\n      switch (obj.objectType) {\n        case 'Point':\n        case 'PointSet':\n          geometry = loader.parse(obj.geometry);\n\n          if (geometry.attributes.hasOwnProperty('color')) {\n            material = new PointsMaterial({\n              vertexColors: true,\n              sizeAttenuation: false,\n              size: 2\n            });\n          } else {\n            _color = attributes.drawColor;\n            color = new Color(_color.r / 255.0, _color.g / 255.0, _color.b / 255.0);\n            material = new PointsMaterial({\n              color: color,\n              sizeAttenuation: false,\n              size: 2\n            });\n          }\n\n          material = this._compareMaterials(material);\n          var points = new Points(geometry, material);\n          points.userData['attributes'] = attributes;\n          points.userData['objectType'] = obj.objectType;\n\n          if (attributes.name) {\n            points.name = attributes.name;\n          }\n\n          return points;\n\n        case 'Mesh':\n        case 'Extrusion':\n        case 'SubD':\n        case 'Brep':\n          if (obj.geometry === null) return;\n          geometry = loader.parse(obj.geometry);\n\n          if (geometry.attributes.hasOwnProperty('color')) {\n            mat.vertexColors = true;\n          }\n\n          if (mat === null) {\n            mat = this._createMaterial();\n            mat = this._compareMaterials(mat);\n          }\n\n          var mesh = new Mesh(geometry, mat);\n          mesh.castShadow = attributes.castsShadows;\n          mesh.receiveShadow = attributes.receivesShadows;\n          mesh.userData['attributes'] = attributes;\n          mesh.userData['objectType'] = obj.objectType;\n\n          if (attributes.name) {\n            mesh.name = attributes.name;\n          }\n\n          return mesh;\n\n        case 'Curve':\n          geometry = loader.parse(obj.geometry);\n          _color = attributes.drawColor;\n          color = new Color(_color.r / 255.0, _color.g / 255.0, _color.b / 255.0);\n          material = new LineBasicMaterial({\n            color: color\n          });\n          material = this._compareMaterials(material);\n          var lines = new Line(geometry, material);\n          lines.userData['attributes'] = attributes;\n          lines.userData['objectType'] = obj.objectType;\n\n          if (attributes.name) {\n            lines.name = attributes.name;\n          }\n\n          return lines;\n\n        case 'TextDot':\n          geometry = obj.geometry;\n          var ctx = document.createElement('canvas').getContext('2d');\n          var font = \"\".concat(geometry.fontHeight, \"px \").concat(geometry.fontFace);\n          ctx.font = font;\n          var width = ctx.measureText(geometry.text).width + 10;\n          var height = geometry.fontHeight + 10;\n          var r = window.devicePixelRatio;\n          ctx.canvas.width = width * r;\n          ctx.canvas.height = height * r;\n          ctx.canvas.style.width = width + 'px';\n          ctx.canvas.style.height = height + 'px';\n          ctx.setTransform(r, 0, 0, r, 0, 0);\n          ctx.font = font;\n          ctx.textBaseline = 'middle';\n          ctx.textAlign = 'center';\n          color = attributes.drawColor;\n          ctx.fillStyle = \"rgba(\".concat(color.r, \",\").concat(color.g, \",\").concat(color.b, \",\").concat(color.a, \")\");\n          ctx.fillRect(0, 0, width, height);\n          ctx.fillStyle = 'white';\n          ctx.fillText(geometry.text, width / 2, height / 2);\n          var texture = new CanvasTexture(ctx.canvas);\n          texture.minFilter = LinearFilter;\n          texture.wrapS = ClampToEdgeWrapping;\n          texture.wrapT = ClampToEdgeWrapping;\n          material = new SpriteMaterial({\n            map: texture,\n            depthTest: false\n          });\n          var sprite = new Sprite(material);\n          sprite.position.set(geometry.point[0], geometry.point[1], geometry.point[2]);\n          sprite.scale.set(width / 10, height / 10, 1.0);\n          sprite.userData['attributes'] = attributes;\n          sprite.userData['objectType'] = obj.objectType;\n\n          if (attributes.name) {\n            sprite.name = attributes.name;\n          }\n\n          return sprite;\n\n        case 'Light':\n          geometry = obj.geometry;\n          var light;\n\n          if (geometry.isDirectionalLight) {\n            light = new DirectionalLight();\n            light.castShadow = attributes.castsShadows;\n            light.position.set(geometry.location[0], geometry.location[1], geometry.location[2]);\n            light.target.position.set(geometry.direction[0], geometry.direction[1], geometry.direction[2]);\n            light.shadow.normalBias = 0.1;\n          } else if (geometry.isPointLight) {\n            light = new PointLight();\n            light.castShadow = attributes.castsShadows;\n            light.position.set(geometry.location[0], geometry.location[1], geometry.location[2]);\n            light.shadow.normalBias = 0.1;\n          } else if (geometry.isRectangularLight) {\n            light = new RectAreaLight();\n\n            var _width = Math.abs(geometry.width[2]);\n\n            var _height = Math.abs(geometry.length[0]);\n\n            light.position.set(geometry.location[0] - _height / 2, geometry.location[1], geometry.location[2] - _width / 2);\n            light.height = _height;\n            light.width = _width;\n            light.lookAt(new Vector3(geometry.direction[0], geometry.direction[1], geometry.direction[2]));\n          } else if (geometry.isSpotLight) {\n            light = new SpotLight();\n            light.castShadow = attributes.castsShadows;\n            light.position.set(geometry.location[0], geometry.location[1], geometry.location[2]);\n            light.target.position.set(geometry.direction[0], geometry.direction[1], geometry.direction[2]);\n            light.angle = geometry.spotAngleRadians;\n            light.shadow.normalBias = 0.1;\n          } else if (geometry.isLinearLight) {\n            console.warn('THREE.3DMLoader:  No conversion exists for linear lights.');\n            return;\n          }\n\n          if (light) {\n            light.intensity = geometry.intensity;\n            _color = geometry.diffuse;\n            color = new Color(_color.r / 255.0, _color.g / 255.0, _color.b / 255.0);\n            light.color = color;\n            light.userData['attributes'] = attributes;\n            light.userData['objectType'] = obj.objectType;\n          }\n\n          return light;\n      }\n    }\n  }, {\n    key: \"_initLibrary\",\n    value: function _initLibrary() {\n      var _this4 = this;\n\n      if (!this.libraryPending) {\n        // Load rhino3dm wrapper.\n        var jsLoader = new FileLoader(this.manager);\n        jsLoader.setPath(this.libraryPath);\n        var jsContent = new Promise(function (resolve, reject) {\n          jsLoader.load('rhino3dm.js', resolve, undefined, reject);\n        }); // Load rhino3dm WASM binary.\n\n        var binaryLoader = new FileLoader(this.manager);\n        binaryLoader.setPath(this.libraryPath);\n        binaryLoader.setResponseType('arraybuffer');\n        var binaryContent = new Promise(function (resolve, reject) {\n          binaryLoader.load('rhino3dm.wasm', resolve, undefined, reject);\n        });\n        this.libraryPending = Promise.all([jsContent, binaryContent]).then(function (_ref) {\n          var _ref2 = _slicedToArray(_ref, 2),\n              jsContent = _ref2[0],\n              binaryContent = _ref2[1];\n\n          //this.libraryBinary = binaryContent;\n          _this4.libraryConfig.wasmBinary = binaryContent;\n          var fn = Rhino3dmWorker.toString();\n          var body = ['/* rhino3dm.js */', jsContent, '/* worker */', fn.substring(fn.indexOf('{') + 1, fn.lastIndexOf('}'))].join('\\n');\n          _this4.workerSourceURL = URL.createObjectURL(new Blob([body]));\n        });\n      }\n\n      return this.libraryPending;\n    }\n  }, {\n    key: \"_getWorker\",\n    value: function _getWorker(taskCost) {\n      var _this5 = this;\n\n      return this._initLibrary().then(function () {\n        if (_this5.workerPool.length < _this5.workerLimit) {\n          var _worker2 = new Worker(_this5.workerSourceURL);\n\n          _worker2._callbacks = {};\n          _worker2._taskCosts = {};\n          _worker2._taskLoad = 0;\n\n          _worker2.postMessage({\n            type: 'init',\n            libraryConfig: _this5.libraryConfig\n          });\n\n          _worker2.onmessage = function (e) {\n            var message = e.data;\n\n            switch (message.type) {\n              case 'decode':\n                _worker2._callbacks[message.id].resolve(message);\n\n                break;\n\n              case 'error':\n                _worker2._callbacks[message.id].reject(message);\n\n                break;\n\n              default:\n                console.error('THREE.Rhino3dmLoader: Unexpected message, \"' + message.type + '\"');\n            }\n          };\n\n          _this5.workerPool.push(_worker2);\n        } else {\n          _this5.workerPool.sort(function (a, b) {\n            return a._taskLoad > b._taskLoad ? -1 : 1;\n          });\n        }\n\n        var worker = _this5.workerPool[_this5.workerPool.length - 1];\n        worker._taskLoad += taskCost;\n        return worker;\n      });\n    }\n  }, {\n    key: \"_releaseTask\",\n    value: function _releaseTask(worker, taskID) {\n      worker._taskLoad -= worker._taskCosts[taskID];\n      delete worker._callbacks[taskID];\n      delete worker._taskCosts[taskID];\n    }\n  }, {\n    key: \"dispose\",\n    value: function dispose() {\n      for (var i = 0; i < this.workerPool.length; ++i) {\n        this.workerPool[i].terminate();\n      }\n\n      this.workerPool.length = 0;\n      return this;\n    }\n  }]);\n\n  return Rhino3dmLoader;\n}(Loader);\n/* WEB WORKER */\n\n\nfunction Rhino3dmWorker() {\n  var libraryPending;\n  var libraryConfig;\n  var rhino;\n\n  onmessage = function onmessage(e) {\n    var message = e.data;\n\n    switch (message.type) {\n      case 'init':\n        libraryConfig = message.libraryConfig;\n        var wasmBinary = libraryConfig.wasmBinary;\n        var RhinoModule;\n        libraryPending = new Promise(function (resolve) {\n          /* Like Basis Loader */\n          RhinoModule = {\n            wasmBinary: wasmBinary,\n            onRuntimeInitialized: resolve\n          };\n          rhino3dm(RhinoModule); // eslint-disable-line no-undef\n        }).then(function () {\n          rhino = RhinoModule;\n        });\n        break;\n\n      case 'decode':\n        var buffer = message.buffer;\n        libraryPending.then(function () {\n          var data = decodeObjects(rhino, buffer);\n          self.postMessage({\n            type: 'decode',\n            id: message.id,\n            data: data\n          });\n        });\n        break;\n    }\n  };\n\n  function decodeObjects(rhino, buffer) {\n    var arr = new Uint8Array(buffer);\n    var doc = rhino.File3dm.fromByteArray(arr);\n    var objects = [];\n    var materials = [];\n    var layers = [];\n    var views = [];\n    var namedViews = [];\n    var groups = []; //Handle objects\n\n    var objs = doc.objects();\n    var cnt = objs.count;\n\n    for (var i = 0; i < cnt; i++) {\n      var _object = objs.get(i);\n\n      var object = extractObjectData(_object, doc);\n\n      _object.delete();\n\n      if (object) {\n        objects.push(object);\n      }\n    } // Handle instance definitions\n    // console.log( `Instance Definitions Count: ${doc.instanceDefinitions().count()}` );\n\n\n    for (var _i2 = 0; _i2 < doc.instanceDefinitions().count(); _i2++) {\n      var idef = doc.instanceDefinitions().get(_i2);\n      var idefAttributes = extractProperties(idef);\n      idefAttributes.objectIds = idef.getObjectIds();\n      objects.push({\n        geometry: null,\n        attributes: idefAttributes,\n        objectType: 'InstanceDefinition'\n      });\n    } // Handle materials\n\n\n    var textureTypes = [// rhino.TextureType.Bitmap,\n    rhino.TextureType.Diffuse, rhino.TextureType.Bump, rhino.TextureType.Transparency, rhino.TextureType.Opacity, rhino.TextureType.Emap];\n    var pbrTextureTypes = [rhino.TextureType.PBR_BaseColor, rhino.TextureType.PBR_Subsurface, rhino.TextureType.PBR_SubsurfaceScattering, rhino.TextureType.PBR_SubsurfaceScatteringRadius, rhino.TextureType.PBR_Metallic, rhino.TextureType.PBR_Specular, rhino.TextureType.PBR_SpecularTint, rhino.TextureType.PBR_Roughness, rhino.TextureType.PBR_Anisotropic, rhino.TextureType.PBR_Anisotropic_Rotation, rhino.TextureType.PBR_Sheen, rhino.TextureType.PBR_SheenTint, rhino.TextureType.PBR_Clearcoat, rhino.TextureType.PBR_ClearcoatBump, rhino.TextureType.PBR_ClearcoatRoughness, rhino.TextureType.PBR_OpacityIor, rhino.TextureType.PBR_OpacityRoughness, rhino.TextureType.PBR_Emission, rhino.TextureType.PBR_AmbientOcclusion, rhino.TextureType.PBR_Displacement];\n\n    for (var _i3 = 0; _i3 < doc.materials().count(); _i3++) {\n      var _material = doc.materials().get(_i3);\n\n      var _pbrMaterial = _material.physicallyBased();\n\n      var material = extractProperties(_material);\n      var textures = [];\n\n      for (var j = 0; j < textureTypes.length; j++) {\n        var _texture = _material.getTexture(textureTypes[j]);\n\n        if (_texture) {\n          var textureType = textureTypes[j].constructor.name;\n          textureType = textureType.substring(12, textureType.length);\n          var texture = {\n            type: textureType\n          };\n          var image = doc.getEmbeddedFileAsBase64(_texture.fileName);\n\n          if (image) {\n            texture.image = 'data:image/png;base64,' + image;\n          } else {\n            console.warn(\"THREE.3DMLoader: Image for \".concat(textureType, \" texture not embedded in file.\"));\n            texture.image = null;\n          }\n\n          textures.push(texture);\n\n          _texture.delete();\n        }\n      }\n\n      material.textures = textures;\n\n      if (_pbrMaterial.supported) {\n        console.log('pbr true');\n\n        for (var _j2 = 0; _j2 < pbrTextureTypes.length; _j2++) {\n          var _texture2 = _material.getTexture(textureTypes[_j2]);\n\n          if (_texture2) {\n            var _image = doc.getEmbeddedFileAsBase64(_texture2.fileName);\n\n            var _textureType = textureTypes[_j2].constructor.name;\n            _textureType = _textureType.substring(12, _textureType.length);\n            var _texture3 = {\n              type: _textureType,\n              image: 'data:image/png;base64,' + _image\n            };\n            textures.push(_texture3);\n\n            _texture2.delete();\n          }\n        }\n\n        var pbMaterialProperties = extractProperties(_material.physicallyBased());\n        material = Object.assign(pbMaterialProperties, material);\n      }\n\n      materials.push(material);\n\n      _material.delete();\n\n      _pbrMaterial.delete();\n    } // Handle layers\n\n\n    for (var _i4 = 0; _i4 < doc.layers().count(); _i4++) {\n      var _layer = doc.layers().get(_i4);\n\n      var layer = extractProperties(_layer);\n      layers.push(layer);\n\n      _layer.delete();\n    } // Handle views\n\n\n    for (var _i5 = 0; _i5 < doc.views().count(); _i5++) {\n      var _view = doc.views().get(_i5);\n\n      var view = extractProperties(_view);\n      views.push(view);\n\n      _view.delete();\n    } // Handle named views\n\n\n    for (var _i6 = 0; _i6 < doc.namedViews().count(); _i6++) {\n      var _namedView = doc.namedViews().get(_i6);\n\n      var namedView = extractProperties(_namedView);\n      namedViews.push(namedView);\n\n      _namedView.delete();\n    } // Handle groups\n\n\n    for (var _i7 = 0; _i7 < doc.groups().count(); _i7++) {\n      var _group = doc.groups().get(_i7);\n\n      var group = extractProperties(_group);\n      groups.push(group);\n\n      _group.delete();\n    } // Handle settings\n\n\n    var settings = extractProperties(doc.settings()); //TODO: Handle other document stuff like dimstyles, instance definitions, bitmaps etc.\n    // Handle dimstyles\n    // console.log( `Dimstyle Count: ${doc.dimstyles().count()}` );\n    // Handle bitmaps\n    // console.log( `Bitmap Count: ${doc.bitmaps().count()}` );\n    // Handle strings -- this seems to be broken at the moment in rhino3dm\n    // console.log( `Document Strings Count: ${doc.strings().count()}` );\n\n    /*\n    for( var i = 0; i < doc.strings().count(); i++ ){\n    var _string= doc.strings().get( i );\n    console.log(_string);\n    var string = extractProperties( _group );\n    strings.push( string );\n    _string.delete();\n    }\n    */\n\n    doc.delete();\n    return {\n      objects: objects,\n      materials: materials,\n      layers: layers,\n      views: views,\n      namedViews: namedViews,\n      groups: groups,\n      settings: settings\n    };\n  }\n\n  function extractObjectData(object, doc) {\n    var _geometry = object.geometry();\n\n    var _attributes = object.attributes();\n\n    var objectType = _geometry.objectType;\n    var geometry, attributes, position, data, mesh; // skip instance definition objects\n    //if( _attributes.isInstanceDefinitionObject ) { continue; }\n    // TODO: handle other geometry types\n\n    switch (objectType) {\n      case rhino.ObjectType.Curve:\n        var pts = curveToPoints(_geometry, 100);\n        position = {};\n        attributes = {};\n        data = {};\n        position.itemSize = 3;\n        position.type = 'Float32Array';\n        position.array = [];\n\n        for (var j = 0; j < pts.length; j++) {\n          position.array.push(pts[j][0]);\n          position.array.push(pts[j][1]);\n          position.array.push(pts[j][2]);\n        }\n\n        attributes.position = position;\n        data.attributes = attributes;\n        geometry = {\n          data: data\n        };\n        break;\n\n      case rhino.ObjectType.Point:\n        var pt = _geometry.location;\n        position = {};\n        var color = {};\n        attributes = {};\n        data = {};\n        position.itemSize = 3;\n        position.type = 'Float32Array';\n        position.array = [pt[0], pt[1], pt[2]];\n\n        var _color = _attributes.drawColor(doc);\n\n        color.itemSize = 3;\n        color.type = 'Float32Array';\n        color.array = [_color.r / 255.0, _color.g / 255.0, _color.b / 255.0];\n        attributes.position = position;\n        attributes.color = color;\n        data.attributes = attributes;\n        geometry = {\n          data: data\n        };\n        break;\n\n      case rhino.ObjectType.PointSet:\n      case rhino.ObjectType.Mesh:\n        geometry = _geometry.toThreejsJSON();\n        break;\n\n      case rhino.ObjectType.Brep:\n        var faces = _geometry.faces();\n\n        mesh = new rhino.Mesh();\n\n        for (var faceIndex = 0; faceIndex < faces.count; faceIndex++) {\n          var face = faces.get(faceIndex);\n\n          var _mesh = face.getMesh(rhino.MeshType.Any);\n\n          if (_mesh) {\n            mesh.append(_mesh);\n\n            _mesh.delete();\n          }\n\n          face.delete();\n        }\n\n        if (mesh.faces().count > 0) {\n          mesh.compact();\n          geometry = mesh.toThreejsJSON();\n          faces.delete();\n        }\n\n        mesh.delete();\n        break;\n\n      case rhino.ObjectType.Extrusion:\n        mesh = _geometry.getMesh(rhino.MeshType.Any);\n\n        if (mesh) {\n          geometry = mesh.toThreejsJSON();\n          mesh.delete();\n        }\n\n        break;\n\n      case rhino.ObjectType.TextDot:\n        geometry = extractProperties(_geometry);\n        break;\n\n      case rhino.ObjectType.Light:\n        geometry = extractProperties(_geometry);\n        break;\n\n      case rhino.ObjectType.InstanceReference:\n        geometry = extractProperties(_geometry);\n        geometry.xform = extractProperties(_geometry.xform);\n        geometry.xform.array = _geometry.xform.toFloatArray(true);\n        break;\n\n      case rhino.ObjectType.SubD:\n        // TODO: precalculate resulting vertices and faces and warn on excessive results\n        _geometry.subdivide(3);\n\n        mesh = rhino.Mesh.createFromSubDControlNet(_geometry);\n\n        if (mesh) {\n          geometry = mesh.toThreejsJSON();\n          mesh.delete();\n        }\n\n        break;\n\n      /*\n      case rhino.ObjectType.Annotation:\n      case rhino.ObjectType.Hatch:\n      case rhino.ObjectType.ClipPlane:\n      */\n\n      default:\n        console.warn(\"THREE.3DMLoader: TODO: Implement \".concat(objectType.constructor.name));\n        break;\n    }\n\n    if (geometry) {\n      attributes = extractProperties(_attributes);\n      attributes.geometry = extractProperties(_geometry);\n\n      if (_attributes.groupCount > 0) {\n        attributes.groupIds = _attributes.getGroupList();\n      }\n\n      if (_attributes.userStringCount > 0) {\n        attributes.userStrings = _attributes.getUserStrings();\n      }\n\n      if (_geometry.userStringCount > 0) {\n        attributes.geometry.userStrings = _geometry.getUserStrings();\n      }\n\n      attributes.drawColor = _attributes.drawColor(doc);\n      objectType = objectType.constructor.name;\n      objectType = objectType.substring(11, objectType.length);\n      return {\n        geometry: geometry,\n        attributes: attributes,\n        objectType: objectType\n      };\n    } else {\n      console.warn(\"THREE.3DMLoader: \".concat(objectType.constructor.name, \" has no associated mesh geometry.\"));\n    }\n  }\n\n  function extractProperties(object) {\n    var result = {};\n\n    for (var property in object) {\n      var value = object[property];\n\n      if (typeof value !== 'function') {\n        if (typeof value === 'object' && value !== null && value.hasOwnProperty('constructor')) {\n          result[property] = {\n            name: value.constructor.name,\n            value: value.value\n          };\n        } else {\n          result[property] = value;\n        }\n      }\n    }\n\n    return result;\n  }\n\n  function curveToPoints(curve, pointLimit) {\n    var pointCount = pointLimit;\n    var rc = [];\n    var ts = [];\n\n    if (curve instanceof rhino.LineCurve) {\n      return [curve.pointAtStart, curve.pointAtEnd];\n    }\n\n    if (curve instanceof rhino.PolylineCurve) {\n      pointCount = curve.pointCount;\n\n      for (var i = 0; i < pointCount; i++) {\n        rc.push(curve.point(i));\n      }\n\n      return rc;\n    }\n\n    if (curve instanceof rhino.PolyCurve) {\n      var segmentCount = curve.segmentCount;\n\n      for (var _i8 = 0; _i8 < segmentCount; _i8++) {\n        var segment = curve.segmentCurve(_i8);\n        var segmentArray = curveToPoints(segment, pointCount);\n        rc = rc.concat(segmentArray);\n        segment.delete();\n      }\n\n      return rc;\n    }\n\n    if (curve instanceof rhino.ArcCurve) {\n      pointCount = Math.floor(curve.angleDegrees / 5);\n      pointCount = pointCount < 2 ? 2 : pointCount; // alternative to this hardcoded version: https://stackoverflow.com/a/18499923/2179399\n    }\n\n    if (curve instanceof rhino.NurbsCurve && curve.degree === 1) {\n      var pLine = curve.tryGetPolyline();\n\n      for (var _i9 = 0; _i9 < pLine.count; _i9++) {\n        rc.push(pLine.get(_i9));\n      }\n\n      pLine.delete();\n      return rc;\n    }\n\n    var domain = curve.domain;\n    var divisions = pointCount - 1.0;\n\n    for (var j = 0; j < pointCount; j++) {\n      var t = domain[0] + j / divisions * (domain[1] - domain[0]);\n\n      if (t === domain[0] || t === domain[1]) {\n        ts.push(t);\n        continue;\n      }\n\n      var tan = curve.tangentAt(t);\n      var prevTan = curve.tangentAt(ts.slice(-1)[0]); // Duplicated from THREE.Vector3\n      // How to pass imports to worker?\n\n      var tS = tan[0] * tan[0] + tan[1] * tan[1] + tan[2] * tan[2];\n      var ptS = prevTan[0] * prevTan[0] + prevTan[1] * prevTan[1] + prevTan[2] * prevTan[2];\n      var denominator = Math.sqrt(tS * ptS);\n      var angle = void 0;\n\n      if (denominator === 0) {\n        angle = Math.PI / 2;\n      } else {\n        var theta = (tan.x * prevTan.x + tan.y * prevTan.y + tan.z * prevTan.z) / denominator;\n        angle = Math.acos(Math.max(-1, Math.min(1, theta)));\n      }\n\n      if (angle < 0.1) continue;\n      ts.push(t);\n    }\n\n    rc = ts.map(function (t) {\n      return curve.pointAt(t);\n    });\n    return rc;\n  }\n}\n\nexport { Rhino3dmLoader };","map":{"version":3,"sources":["/Users/arbus/Documents/SpaceInBrowser/node_modules/three-stdlib/loaders/3DMLoader.js"],"names":["Loader","FileLoader","MeshStandardMaterial","Color","TextureLoader","Object3D","Matrix4","BufferGeometryLoader","DirectionalLight","PointLight","RectAreaLight","Vector3","SpotLight","CanvasTexture","LinearFilter","ClampToEdgeWrapping","SpriteMaterial","Sprite","LineBasicMaterial","Line","Mesh","PointsMaterial","Points","_taskCache","WeakMap","Rhino3dmLoader","manager","libraryPath","libraryPending","libraryBinary","libraryConfig","url","workerLimit","workerPool","workerNextTaskID","workerSourceURL","workerConfig","materials","path","onLoad","onProgress","onError","loader","setPath","setResponseType","setRequestHeader","requestHeader","load","buffer","has","cachedTask","get","promise","then","catch","decodeObjects","console","log","map","worker","_taskLoad","taskID","taskCost","byteLength","objectPending","_getWorker","_worker","Promise","resolve","reject","_callbacks","postMessage","type","id","message","_createGeometry","data","_releaseTask","set","material","mat","name","color","r","g","b","i","length","m","_mat","JSON","stringify","push","undefined","metalness","side","_diffuseColor","diffuseColor","diffusecolor","transparent","transparency","opacity","textureLoader","textures","texture","image","bumpMap","alphaMap","envMap","object","instanceDefinitionObjects","instanceDefinitions","instanceReferences","userData","layers","groups","settings","objects","obj","attributes","objectType","_object","materialIndex","rMaterial","_createMaterial","_compareMaterials","_createObject","layer","layerIndex","visible","isInstanceDefinitionObject","add","iDef","j","objectIds","objId","p","idoId","iRef","geometry","parentIdefId","iRefObject","xf","xform","array","matrix","applyMatrix4","clone","_color","parse","hasOwnProperty","vertexColors","sizeAttenuation","size","drawColor","points","mesh","castShadow","castsShadows","receiveShadow","receivesShadows","lines","ctx","document","createElement","getContext","font","fontHeight","fontFace","width","measureText","text","height","window","devicePixelRatio","canvas","style","setTransform","textBaseline","textAlign","fillStyle","a","fillRect","fillText","minFilter","wrapS","wrapT","depthTest","sprite","position","point","scale","light","isDirectionalLight","location","target","direction","shadow","normalBias","isPointLight","isRectangularLight","Math","abs","lookAt","isSpotLight","angle","spotAngleRadians","isLinearLight","warn","intensity","diffuse","jsLoader","jsContent","binaryLoader","binaryContent","all","wasmBinary","fn","Rhino3dmWorker","toString","body","substring","indexOf","lastIndexOf","join","URL","createObjectURL","Blob","_initLibrary","Worker","_taskCosts","onmessage","e","error","sort","terminate","rhino","RhinoModule","onRuntimeInitialized","rhino3dm","self","arr","Uint8Array","doc","File3dm","fromByteArray","views","namedViews","objs","cnt","count","extractObjectData","delete","idef","idefAttributes","extractProperties","getObjectIds","textureTypes","TextureType","Diffuse","Bump","Transparency","Opacity","Emap","pbrTextureTypes","PBR_BaseColor","PBR_Subsurface","PBR_SubsurfaceScattering","PBR_SubsurfaceScatteringRadius","PBR_Metallic","PBR_Specular","PBR_SpecularTint","PBR_Roughness","PBR_Anisotropic","PBR_Anisotropic_Rotation","PBR_Sheen","PBR_SheenTint","PBR_Clearcoat","PBR_ClearcoatBump","PBR_ClearcoatRoughness","PBR_OpacityIor","PBR_OpacityRoughness","PBR_Emission","PBR_AmbientOcclusion","PBR_Displacement","_material","_pbrMaterial","physicallyBased","_texture","getTexture","textureType","constructor","getEmbeddedFileAsBase64","fileName","supported","pbMaterialProperties","Object","assign","_layer","_view","view","_namedView","namedView","_group","group","_geometry","_attributes","ObjectType","Curve","pts","curveToPoints","itemSize","Point","pt","PointSet","toThreejsJSON","Brep","faces","faceIndex","face","_mesh","getMesh","MeshType","Any","append","compact","Extrusion","TextDot","Light","InstanceReference","toFloatArray","SubD","subdivide","createFromSubDControlNet","groupCount","groupIds","getGroupList","userStringCount","userStrings","getUserStrings","result","property","value","curve","pointLimit","pointCount","rc","ts","LineCurve","pointAtStart","pointAtEnd","PolylineCurve","PolyCurve","segmentCount","segment","segmentCurve","segmentArray","concat","ArcCurve","floor","angleDegrees","NurbsCurve","degree","pLine","tryGetPolyline","domain","divisions","t","tan","tangentAt","prevTan","slice","tS","ptS","denominator","sqrt","PI","theta","x","y","z","acos","max","min","pointAt"],"mappings":"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","sourcesContent":["import { Loader, FileLoader, MeshStandardMaterial, Color, TextureLoader, Object3D, Matrix4, BufferGeometryLoader, DirectionalLight, PointLight, RectAreaLight, Vector3, SpotLight, CanvasTexture, LinearFilter, ClampToEdgeWrapping, SpriteMaterial, Sprite, LineBasicMaterial, Line, Mesh, PointsMaterial, Points } from 'three';\n\nconst _taskCache = new WeakMap();\n\nclass Rhino3dmLoader extends Loader {\n  constructor(manager) {\n    super(manager);\n    this.libraryPath = '';\n    this.libraryPending = null;\n    this.libraryBinary = null;\n    this.libraryConfig = {};\n    this.url = '';\n    this.workerLimit = 4;\n    this.workerPool = [];\n    this.workerNextTaskID = 1;\n    this.workerSourceURL = '';\n    this.workerConfig = {};\n    this.materials = [];\n  }\n\n  setLibraryPath(path) {\n    this.libraryPath = path;\n    return this;\n  }\n\n  setWorkerLimit(workerLimit) {\n    this.workerLimit = workerLimit;\n    return this;\n  }\n\n  load(url, onLoad, onProgress, onError) {\n    const loader = new FileLoader(this.manager);\n    loader.setPath(this.path);\n    loader.setResponseType('arraybuffer');\n    loader.setRequestHeader(this.requestHeader);\n    this.url = url;\n    loader.load(url, buffer => {\n      // Check for an existing task using this buffer. A transferred buffer cannot be transferred\n      // again from this thread.\n      if (_taskCache.has(buffer)) {\n        const cachedTask = _taskCache.get(buffer);\n\n        return cachedTask.promise.then(onLoad).catch(onError);\n      }\n\n      this.decodeObjects(buffer, url).then(onLoad).catch(onError);\n    }, onProgress, onError);\n  }\n\n  debug() {\n    console.log('Task load: ', this.workerPool.map(worker => worker._taskLoad));\n  }\n\n  decodeObjects(buffer, url) {\n    let worker;\n    let taskID;\n    const taskCost = buffer.byteLength;\n\n    const objectPending = this._getWorker(taskCost).then(_worker => {\n      worker = _worker;\n      taskID = this.workerNextTaskID++; //hmmm\n\n      return new Promise((resolve, reject) => {\n        worker._callbacks[taskID] = {\n          resolve,\n          reject\n        };\n        worker.postMessage({\n          type: 'decode',\n          id: taskID,\n          buffer\n        }, [buffer]); //this.debug();\n      });\n    }).then(message => this._createGeometry(message.data)); // Remove task from the task list.\n    // Note: replaced '.finally()' with '.catch().then()' block - iOS 11 support (#19416)\n\n\n    objectPending.catch(() => true).then(() => {\n      if (worker && taskID) {\n        this._releaseTask(worker, taskID); //this.debug();\n\n      }\n    }); // Cache the task result.\n\n    _taskCache.set(buffer, {\n      url: url,\n      promise: objectPending\n    });\n\n    return objectPending;\n  }\n\n  parse(data, onLoad, onError) {\n    this.decodeObjects(data, '').then(onLoad).catch(onError);\n  }\n\n  _compareMaterials(material) {\n    const mat = {};\n    mat.name = material.name;\n    mat.color = {};\n    mat.color.r = material.color.r;\n    mat.color.g = material.color.g;\n    mat.color.b = material.color.b;\n    mat.type = material.type;\n\n    for (let i = 0; i < this.materials.length; i++) {\n      const m = this.materials[i];\n      const _mat = {};\n      _mat.name = m.name;\n      _mat.color = {};\n      _mat.color.r = m.color.r;\n      _mat.color.g = m.color.g;\n      _mat.color.b = m.color.b;\n      _mat.type = m.type;\n\n      if (JSON.stringify(mat) === JSON.stringify(_mat)) {\n        return m;\n      }\n    }\n\n    this.materials.push(material);\n    return material;\n  }\n\n  _createMaterial(material) {\n    if (material === undefined) {\n      return new MeshStandardMaterial({\n        color: new Color(1, 1, 1),\n        metalness: 0.8,\n        name: 'default',\n        side: 2\n      });\n    }\n\n    const _diffuseColor = material.diffuseColor;\n    const diffusecolor = new Color(_diffuseColor.r / 255.0, _diffuseColor.g / 255.0, _diffuseColor.b / 255.0);\n\n    if (_diffuseColor.r === 0 && _diffuseColor.g === 0 && _diffuseColor.b === 0) {\n      diffusecolor.r = 1;\n      diffusecolor.g = 1;\n      diffusecolor.b = 1;\n    } // console.log( material );\n\n\n    const mat = new MeshStandardMaterial({\n      color: diffusecolor,\n      name: material.name,\n      side: 2,\n      transparent: material.transparency > 0 ? true : false,\n      opacity: 1.0 - material.transparency\n    });\n    const textureLoader = new TextureLoader();\n\n    for (let i = 0; i < material.textures.length; i++) {\n      const texture = material.textures[i];\n\n      if (texture.image !== null) {\n        const map = textureLoader.load(texture.image);\n\n        switch (texture.type) {\n          case 'Diffuse':\n            mat.map = map;\n            break;\n\n          case 'Bump':\n            mat.bumpMap = map;\n            break;\n\n          case 'Transparency':\n            mat.alphaMap = map;\n            mat.transparent = true;\n            break;\n\n          case 'Emap':\n            mat.envMap = map;\n            break;\n        }\n      }\n    }\n\n    return mat;\n  }\n\n  _createGeometry(data) {\n    // console.log(data);\n    const object = new Object3D();\n    const instanceDefinitionObjects = [];\n    const instanceDefinitions = [];\n    const instanceReferences = [];\n    object.userData['layers'] = data.layers;\n    object.userData['groups'] = data.groups;\n    object.userData['settings'] = data.settings;\n    object.userData['objectType'] = 'File3dm';\n    object.userData['materials'] = null;\n    object.name = this.url;\n    let objects = data.objects;\n    const materials = data.materials;\n\n    for (let i = 0; i < objects.length; i++) {\n      const obj = objects[i];\n      const attributes = obj.attributes;\n\n      switch (obj.objectType) {\n        case 'InstanceDefinition':\n          instanceDefinitions.push(obj);\n          break;\n\n        case 'InstanceReference':\n          instanceReferences.push(obj);\n          break;\n\n        default:\n          let _object;\n\n          if (attributes.materialIndex >= 0) {\n            const rMaterial = materials[attributes.materialIndex];\n\n            let material = this._createMaterial(rMaterial);\n\n            material = this._compareMaterials(material);\n            _object = this._createObject(obj, material);\n          } else {\n            const material = this._createMaterial();\n\n            _object = this._createObject(obj, material);\n          }\n\n          if (_object === undefined) {\n            continue;\n          }\n\n          const layer = data.layers[attributes.layerIndex];\n          _object.visible = layer ? data.layers[attributes.layerIndex].visible : true;\n\n          if (attributes.isInstanceDefinitionObject) {\n            instanceDefinitionObjects.push(_object);\n          } else {\n            object.add(_object);\n          }\n\n          break;\n      }\n    }\n\n    for (let i = 0; i < instanceDefinitions.length; i++) {\n      const iDef = instanceDefinitions[i];\n      objects = [];\n\n      for (let j = 0; j < iDef.attributes.objectIds.length; j++) {\n        const objId = iDef.attributes.objectIds[j];\n\n        for (let p = 0; p < instanceDefinitionObjects.length; p++) {\n          const idoId = instanceDefinitionObjects[p].userData.attributes.id;\n\n          if (objId === idoId) {\n            objects.push(instanceDefinitionObjects[p]);\n          }\n        }\n      } // Currently clones geometry and does not take advantage of instancing\n\n\n      for (let j = 0; j < instanceReferences.length; j++) {\n        const iRef = instanceReferences[j];\n\n        if (iRef.geometry.parentIdefId === iDef.attributes.id) {\n          const iRefObject = new Object3D();\n          const xf = iRef.geometry.xform.array;\n          const matrix = new Matrix4();\n          matrix.set(xf[0], xf[1], xf[2], xf[3], xf[4], xf[5], xf[6], xf[7], xf[8], xf[9], xf[10], xf[11], xf[12], xf[13], xf[14], xf[15]);\n          iRefObject.applyMatrix4(matrix);\n\n          for (let p = 0; p < objects.length; p++) {\n            iRefObject.add(objects[p].clone(true));\n          }\n\n          object.add(iRefObject);\n        }\n      }\n    }\n\n    object.userData['materials'] = this.materials;\n    return object;\n  }\n\n  _createObject(obj, mat) {\n    const loader = new BufferGeometryLoader();\n    const attributes = obj.attributes;\n\n    let geometry, material, _color, color;\n\n    switch (obj.objectType) {\n      case 'Point':\n      case 'PointSet':\n        geometry = loader.parse(obj.geometry);\n\n        if (geometry.attributes.hasOwnProperty('color')) {\n          material = new PointsMaterial({\n            vertexColors: true,\n            sizeAttenuation: false,\n            size: 2\n          });\n        } else {\n          _color = attributes.drawColor;\n          color = new Color(_color.r / 255.0, _color.g / 255.0, _color.b / 255.0);\n          material = new PointsMaterial({\n            color: color,\n            sizeAttenuation: false,\n            size: 2\n          });\n        }\n\n        material = this._compareMaterials(material);\n        const points = new Points(geometry, material);\n        points.userData['attributes'] = attributes;\n        points.userData['objectType'] = obj.objectType;\n\n        if (attributes.name) {\n          points.name = attributes.name;\n        }\n\n        return points;\n\n      case 'Mesh':\n      case 'Extrusion':\n      case 'SubD':\n      case 'Brep':\n        if (obj.geometry === null) return;\n        geometry = loader.parse(obj.geometry);\n\n        if (geometry.attributes.hasOwnProperty('color')) {\n          mat.vertexColors = true;\n        }\n\n        if (mat === null) {\n          mat = this._createMaterial();\n          mat = this._compareMaterials(mat);\n        }\n\n        const mesh = new Mesh(geometry, mat);\n        mesh.castShadow = attributes.castsShadows;\n        mesh.receiveShadow = attributes.receivesShadows;\n        mesh.userData['attributes'] = attributes;\n        mesh.userData['objectType'] = obj.objectType;\n\n        if (attributes.name) {\n          mesh.name = attributes.name;\n        }\n\n        return mesh;\n\n      case 'Curve':\n        geometry = loader.parse(obj.geometry);\n        _color = attributes.drawColor;\n        color = new Color(_color.r / 255.0, _color.g / 255.0, _color.b / 255.0);\n        material = new LineBasicMaterial({\n          color: color\n        });\n        material = this._compareMaterials(material);\n        const lines = new Line(geometry, material);\n        lines.userData['attributes'] = attributes;\n        lines.userData['objectType'] = obj.objectType;\n\n        if (attributes.name) {\n          lines.name = attributes.name;\n        }\n\n        return lines;\n\n      case 'TextDot':\n        geometry = obj.geometry;\n        const ctx = document.createElement('canvas').getContext('2d');\n        const font = `${geometry.fontHeight}px ${geometry.fontFace}`;\n        ctx.font = font;\n        const width = ctx.measureText(geometry.text).width + 10;\n        const height = geometry.fontHeight + 10;\n        const r = window.devicePixelRatio;\n        ctx.canvas.width = width * r;\n        ctx.canvas.height = height * r;\n        ctx.canvas.style.width = width + 'px';\n        ctx.canvas.style.height = height + 'px';\n        ctx.setTransform(r, 0, 0, r, 0, 0);\n        ctx.font = font;\n        ctx.textBaseline = 'middle';\n        ctx.textAlign = 'center';\n        color = attributes.drawColor;\n        ctx.fillStyle = `rgba(${color.r},${color.g},${color.b},${color.a})`;\n        ctx.fillRect(0, 0, width, height);\n        ctx.fillStyle = 'white';\n        ctx.fillText(geometry.text, width / 2, height / 2);\n        const texture = new CanvasTexture(ctx.canvas);\n        texture.minFilter = LinearFilter;\n        texture.wrapS = ClampToEdgeWrapping;\n        texture.wrapT = ClampToEdgeWrapping;\n        material = new SpriteMaterial({\n          map: texture,\n          depthTest: false\n        });\n        const sprite = new Sprite(material);\n        sprite.position.set(geometry.point[0], geometry.point[1], geometry.point[2]);\n        sprite.scale.set(width / 10, height / 10, 1.0);\n        sprite.userData['attributes'] = attributes;\n        sprite.userData['objectType'] = obj.objectType;\n\n        if (attributes.name) {\n          sprite.name = attributes.name;\n        }\n\n        return sprite;\n\n      case 'Light':\n        geometry = obj.geometry;\n        let light;\n\n        if (geometry.isDirectionalLight) {\n          light = new DirectionalLight();\n          light.castShadow = attributes.castsShadows;\n          light.position.set(geometry.location[0], geometry.location[1], geometry.location[2]);\n          light.target.position.set(geometry.direction[0], geometry.direction[1], geometry.direction[2]);\n          light.shadow.normalBias = 0.1;\n        } else if (geometry.isPointLight) {\n          light = new PointLight();\n          light.castShadow = attributes.castsShadows;\n          light.position.set(geometry.location[0], geometry.location[1], geometry.location[2]);\n          light.shadow.normalBias = 0.1;\n        } else if (geometry.isRectangularLight) {\n          light = new RectAreaLight();\n          const width = Math.abs(geometry.width[2]);\n          const height = Math.abs(geometry.length[0]);\n          light.position.set(geometry.location[0] - height / 2, geometry.location[1], geometry.location[2] - width / 2);\n          light.height = height;\n          light.width = width;\n          light.lookAt(new Vector3(geometry.direction[0], geometry.direction[1], geometry.direction[2]));\n        } else if (geometry.isSpotLight) {\n          light = new SpotLight();\n          light.castShadow = attributes.castsShadows;\n          light.position.set(geometry.location[0], geometry.location[1], geometry.location[2]);\n          light.target.position.set(geometry.direction[0], geometry.direction[1], geometry.direction[2]);\n          light.angle = geometry.spotAngleRadians;\n          light.shadow.normalBias = 0.1;\n        } else if (geometry.isLinearLight) {\n          console.warn('THREE.3DMLoader:  No conversion exists for linear lights.');\n          return;\n        }\n\n        if (light) {\n          light.intensity = geometry.intensity;\n          _color = geometry.diffuse;\n          color = new Color(_color.r / 255.0, _color.g / 255.0, _color.b / 255.0);\n          light.color = color;\n          light.userData['attributes'] = attributes;\n          light.userData['objectType'] = obj.objectType;\n        }\n\n        return light;\n    }\n  }\n\n  _initLibrary() {\n    if (!this.libraryPending) {\n      // Load rhino3dm wrapper.\n      const jsLoader = new FileLoader(this.manager);\n      jsLoader.setPath(this.libraryPath);\n      const jsContent = new Promise((resolve, reject) => {\n        jsLoader.load('rhino3dm.js', resolve, undefined, reject);\n      }); // Load rhino3dm WASM binary.\n\n      const binaryLoader = new FileLoader(this.manager);\n      binaryLoader.setPath(this.libraryPath);\n      binaryLoader.setResponseType('arraybuffer');\n      const binaryContent = new Promise((resolve, reject) => {\n        binaryLoader.load('rhino3dm.wasm', resolve, undefined, reject);\n      });\n      this.libraryPending = Promise.all([jsContent, binaryContent]).then(([jsContent, binaryContent]) => {\n        //this.libraryBinary = binaryContent;\n        this.libraryConfig.wasmBinary = binaryContent;\n        const fn = Rhino3dmWorker.toString();\n        const body = ['/* rhino3dm.js */', jsContent, '/* worker */', fn.substring(fn.indexOf('{') + 1, fn.lastIndexOf('}'))].join('\\n');\n        this.workerSourceURL = URL.createObjectURL(new Blob([body]));\n      });\n    }\n\n    return this.libraryPending;\n  }\n\n  _getWorker(taskCost) {\n    return this._initLibrary().then(() => {\n      if (this.workerPool.length < this.workerLimit) {\n        const worker = new Worker(this.workerSourceURL);\n        worker._callbacks = {};\n        worker._taskCosts = {};\n        worker._taskLoad = 0;\n        worker.postMessage({\n          type: 'init',\n          libraryConfig: this.libraryConfig\n        });\n\n        worker.onmessage = function (e) {\n          const message = e.data;\n\n          switch (message.type) {\n            case 'decode':\n              worker._callbacks[message.id].resolve(message);\n\n              break;\n\n            case 'error':\n              worker._callbacks[message.id].reject(message);\n\n              break;\n\n            default:\n              console.error('THREE.Rhino3dmLoader: Unexpected message, \"' + message.type + '\"');\n          }\n        };\n\n        this.workerPool.push(worker);\n      } else {\n        this.workerPool.sort(function (a, b) {\n          return a._taskLoad > b._taskLoad ? -1 : 1;\n        });\n      }\n\n      const worker = this.workerPool[this.workerPool.length - 1];\n      worker._taskLoad += taskCost;\n      return worker;\n    });\n  }\n\n  _releaseTask(worker, taskID) {\n    worker._taskLoad -= worker._taskCosts[taskID];\n    delete worker._callbacks[taskID];\n    delete worker._taskCosts[taskID];\n  }\n\n  dispose() {\n    for (let i = 0; i < this.workerPool.length; ++i) {\n      this.workerPool[i].terminate();\n    }\n\n    this.workerPool.length = 0;\n    return this;\n  }\n\n}\n/* WEB WORKER */\n\n\nfunction Rhino3dmWorker() {\n  let libraryPending;\n  let libraryConfig;\n  let rhino;\n\n  onmessage = function (e) {\n    const message = e.data;\n\n    switch (message.type) {\n      case 'init':\n        libraryConfig = message.libraryConfig;\n        const wasmBinary = libraryConfig.wasmBinary;\n        let RhinoModule;\n        libraryPending = new Promise(function (resolve) {\n          /* Like Basis Loader */\n          RhinoModule = {\n            wasmBinary,\n            onRuntimeInitialized: resolve\n          };\n          rhino3dm(RhinoModule); // eslint-disable-line no-undef\n        }).then(() => {\n          rhino = RhinoModule;\n        });\n        break;\n\n      case 'decode':\n        const buffer = message.buffer;\n        libraryPending.then(() => {\n          const data = decodeObjects(rhino, buffer);\n          self.postMessage({\n            type: 'decode',\n            id: message.id,\n            data\n          });\n        });\n        break;\n    }\n  };\n\n  function decodeObjects(rhino, buffer) {\n    const arr = new Uint8Array(buffer);\n    const doc = rhino.File3dm.fromByteArray(arr);\n    const objects = [];\n    const materials = [];\n    const layers = [];\n    const views = [];\n    const namedViews = [];\n    const groups = []; //Handle objects\n\n    const objs = doc.objects();\n    const cnt = objs.count;\n\n    for (let i = 0; i < cnt; i++) {\n      const _object = objs.get(i);\n\n      const object = extractObjectData(_object, doc);\n\n      _object.delete();\n\n      if (object) {\n        objects.push(object);\n      }\n    } // Handle instance definitions\n    // console.log( `Instance Definitions Count: ${doc.instanceDefinitions().count()}` );\n\n\n    for (let i = 0; i < doc.instanceDefinitions().count(); i++) {\n      const idef = doc.instanceDefinitions().get(i);\n      const idefAttributes = extractProperties(idef);\n      idefAttributes.objectIds = idef.getObjectIds();\n      objects.push({\n        geometry: null,\n        attributes: idefAttributes,\n        objectType: 'InstanceDefinition'\n      });\n    } // Handle materials\n\n\n    const textureTypes = [// rhino.TextureType.Bitmap,\n    rhino.TextureType.Diffuse, rhino.TextureType.Bump, rhino.TextureType.Transparency, rhino.TextureType.Opacity, rhino.TextureType.Emap];\n    const pbrTextureTypes = [rhino.TextureType.PBR_BaseColor, rhino.TextureType.PBR_Subsurface, rhino.TextureType.PBR_SubsurfaceScattering, rhino.TextureType.PBR_SubsurfaceScatteringRadius, rhino.TextureType.PBR_Metallic, rhino.TextureType.PBR_Specular, rhino.TextureType.PBR_SpecularTint, rhino.TextureType.PBR_Roughness, rhino.TextureType.PBR_Anisotropic, rhino.TextureType.PBR_Anisotropic_Rotation, rhino.TextureType.PBR_Sheen, rhino.TextureType.PBR_SheenTint, rhino.TextureType.PBR_Clearcoat, rhino.TextureType.PBR_ClearcoatBump, rhino.TextureType.PBR_ClearcoatRoughness, rhino.TextureType.PBR_OpacityIor, rhino.TextureType.PBR_OpacityRoughness, rhino.TextureType.PBR_Emission, rhino.TextureType.PBR_AmbientOcclusion, rhino.TextureType.PBR_Displacement];\n\n    for (let i = 0; i < doc.materials().count(); i++) {\n      const _material = doc.materials().get(i);\n\n      const _pbrMaterial = _material.physicallyBased();\n\n      let material = extractProperties(_material);\n      const textures = [];\n\n      for (let j = 0; j < textureTypes.length; j++) {\n        const _texture = _material.getTexture(textureTypes[j]);\n\n        if (_texture) {\n          let textureType = textureTypes[j].constructor.name;\n          textureType = textureType.substring(12, textureType.length);\n          const texture = {\n            type: textureType\n          };\n          const image = doc.getEmbeddedFileAsBase64(_texture.fileName);\n\n          if (image) {\n            texture.image = 'data:image/png;base64,' + image;\n          } else {\n            console.warn(`THREE.3DMLoader: Image for ${textureType} texture not embedded in file.`);\n            texture.image = null;\n          }\n\n          textures.push(texture);\n\n          _texture.delete();\n        }\n      }\n\n      material.textures = textures;\n\n      if (_pbrMaterial.supported) {\n        console.log('pbr true');\n\n        for (let j = 0; j < pbrTextureTypes.length; j++) {\n          const _texture = _material.getTexture(textureTypes[j]);\n\n          if (_texture) {\n            const image = doc.getEmbeddedFileAsBase64(_texture.fileName);\n            let textureType = textureTypes[j].constructor.name;\n            textureType = textureType.substring(12, textureType.length);\n            const texture = {\n              type: textureType,\n              image: 'data:image/png;base64,' + image\n            };\n            textures.push(texture);\n\n            _texture.delete();\n          }\n        }\n\n        const pbMaterialProperties = extractProperties(_material.physicallyBased());\n        material = Object.assign(pbMaterialProperties, material);\n      }\n\n      materials.push(material);\n\n      _material.delete();\n\n      _pbrMaterial.delete();\n    } // Handle layers\n\n\n    for (let i = 0; i < doc.layers().count(); i++) {\n      const _layer = doc.layers().get(i);\n\n      const layer = extractProperties(_layer);\n      layers.push(layer);\n\n      _layer.delete();\n    } // Handle views\n\n\n    for (let i = 0; i < doc.views().count(); i++) {\n      const _view = doc.views().get(i);\n\n      const view = extractProperties(_view);\n      views.push(view);\n\n      _view.delete();\n    } // Handle named views\n\n\n    for (let i = 0; i < doc.namedViews().count(); i++) {\n      const _namedView = doc.namedViews().get(i);\n\n      const namedView = extractProperties(_namedView);\n      namedViews.push(namedView);\n\n      _namedView.delete();\n    } // Handle groups\n\n\n    for (let i = 0; i < doc.groups().count(); i++) {\n      const _group = doc.groups().get(i);\n\n      const group = extractProperties(_group);\n      groups.push(group);\n\n      _group.delete();\n    } // Handle settings\n\n\n    const settings = extractProperties(doc.settings()); //TODO: Handle other document stuff like dimstyles, instance definitions, bitmaps etc.\n    // Handle dimstyles\n    // console.log( `Dimstyle Count: ${doc.dimstyles().count()}` );\n    // Handle bitmaps\n    // console.log( `Bitmap Count: ${doc.bitmaps().count()}` );\n    // Handle strings -- this seems to be broken at the moment in rhino3dm\n    // console.log( `Document Strings Count: ${doc.strings().count()}` );\n\n    /*\n    for( var i = 0; i < doc.strings().count(); i++ ){\n    var _string= doc.strings().get( i );\n    console.log(_string);\n    var string = extractProperties( _group );\n    strings.push( string );\n    _string.delete();\n    }\n    */\n\n    doc.delete();\n    return {\n      objects,\n      materials,\n      layers,\n      views,\n      namedViews,\n      groups,\n      settings\n    };\n  }\n\n  function extractObjectData(object, doc) {\n    const _geometry = object.geometry();\n\n    const _attributes = object.attributes();\n\n    let objectType = _geometry.objectType;\n    let geometry, attributes, position, data, mesh; // skip instance definition objects\n    //if( _attributes.isInstanceDefinitionObject ) { continue; }\n    // TODO: handle other geometry types\n\n    switch (objectType) {\n      case rhino.ObjectType.Curve:\n        const pts = curveToPoints(_geometry, 100);\n        position = {};\n        attributes = {};\n        data = {};\n        position.itemSize = 3;\n        position.type = 'Float32Array';\n        position.array = [];\n\n        for (let j = 0; j < pts.length; j++) {\n          position.array.push(pts[j][0]);\n          position.array.push(pts[j][1]);\n          position.array.push(pts[j][2]);\n        }\n\n        attributes.position = position;\n        data.attributes = attributes;\n        geometry = {\n          data\n        };\n        break;\n\n      case rhino.ObjectType.Point:\n        const pt = _geometry.location;\n        position = {};\n        const color = {};\n        attributes = {};\n        data = {};\n        position.itemSize = 3;\n        position.type = 'Float32Array';\n        position.array = [pt[0], pt[1], pt[2]];\n\n        const _color = _attributes.drawColor(doc);\n\n        color.itemSize = 3;\n        color.type = 'Float32Array';\n        color.array = [_color.r / 255.0, _color.g / 255.0, _color.b / 255.0];\n        attributes.position = position;\n        attributes.color = color;\n        data.attributes = attributes;\n        geometry = {\n          data\n        };\n        break;\n\n      case rhino.ObjectType.PointSet:\n      case rhino.ObjectType.Mesh:\n        geometry = _geometry.toThreejsJSON();\n        break;\n\n      case rhino.ObjectType.Brep:\n        const faces = _geometry.faces();\n\n        mesh = new rhino.Mesh();\n\n        for (let faceIndex = 0; faceIndex < faces.count; faceIndex++) {\n          const face = faces.get(faceIndex);\n\n          const _mesh = face.getMesh(rhino.MeshType.Any);\n\n          if (_mesh) {\n            mesh.append(_mesh);\n\n            _mesh.delete();\n          }\n\n          face.delete();\n        }\n\n        if (mesh.faces().count > 0) {\n          mesh.compact();\n          geometry = mesh.toThreejsJSON();\n          faces.delete();\n        }\n\n        mesh.delete();\n        break;\n\n      case rhino.ObjectType.Extrusion:\n        mesh = _geometry.getMesh(rhino.MeshType.Any);\n\n        if (mesh) {\n          geometry = mesh.toThreejsJSON();\n          mesh.delete();\n        }\n\n        break;\n\n      case rhino.ObjectType.TextDot:\n        geometry = extractProperties(_geometry);\n        break;\n\n      case rhino.ObjectType.Light:\n        geometry = extractProperties(_geometry);\n        break;\n\n      case rhino.ObjectType.InstanceReference:\n        geometry = extractProperties(_geometry);\n        geometry.xform = extractProperties(_geometry.xform);\n        geometry.xform.array = _geometry.xform.toFloatArray(true);\n        break;\n\n      case rhino.ObjectType.SubD:\n        // TODO: precalculate resulting vertices and faces and warn on excessive results\n        _geometry.subdivide(3);\n\n        mesh = rhino.Mesh.createFromSubDControlNet(_geometry);\n\n        if (mesh) {\n          geometry = mesh.toThreejsJSON();\n          mesh.delete();\n        }\n\n        break;\n\n      /*\n      case rhino.ObjectType.Annotation:\n      case rhino.ObjectType.Hatch:\n      case rhino.ObjectType.ClipPlane:\n      */\n\n      default:\n        console.warn(`THREE.3DMLoader: TODO: Implement ${objectType.constructor.name}`);\n        break;\n    }\n\n    if (geometry) {\n      attributes = extractProperties(_attributes);\n      attributes.geometry = extractProperties(_geometry);\n\n      if (_attributes.groupCount > 0) {\n        attributes.groupIds = _attributes.getGroupList();\n      }\n\n      if (_attributes.userStringCount > 0) {\n        attributes.userStrings = _attributes.getUserStrings();\n      }\n\n      if (_geometry.userStringCount > 0) {\n        attributes.geometry.userStrings = _geometry.getUserStrings();\n      }\n\n      attributes.drawColor = _attributes.drawColor(doc);\n      objectType = objectType.constructor.name;\n      objectType = objectType.substring(11, objectType.length);\n      return {\n        geometry,\n        attributes,\n        objectType\n      };\n    } else {\n      console.warn(`THREE.3DMLoader: ${objectType.constructor.name} has no associated mesh geometry.`);\n    }\n  }\n\n  function extractProperties(object) {\n    const result = {};\n\n    for (const property in object) {\n      const value = object[property];\n\n      if (typeof value !== 'function') {\n        if (typeof value === 'object' && value !== null && value.hasOwnProperty('constructor')) {\n          result[property] = {\n            name: value.constructor.name,\n            value: value.value\n          };\n        } else {\n          result[property] = value;\n        }\n      }\n    }\n\n    return result;\n  }\n\n  function curveToPoints(curve, pointLimit) {\n    let pointCount = pointLimit;\n    let rc = [];\n    const ts = [];\n\n    if (curve instanceof rhino.LineCurve) {\n      return [curve.pointAtStart, curve.pointAtEnd];\n    }\n\n    if (curve instanceof rhino.PolylineCurve) {\n      pointCount = curve.pointCount;\n\n      for (let i = 0; i < pointCount; i++) {\n        rc.push(curve.point(i));\n      }\n\n      return rc;\n    }\n\n    if (curve instanceof rhino.PolyCurve) {\n      const segmentCount = curve.segmentCount;\n\n      for (let i = 0; i < segmentCount; i++) {\n        const segment = curve.segmentCurve(i);\n        const segmentArray = curveToPoints(segment, pointCount);\n        rc = rc.concat(segmentArray);\n        segment.delete();\n      }\n\n      return rc;\n    }\n\n    if (curve instanceof rhino.ArcCurve) {\n      pointCount = Math.floor(curve.angleDegrees / 5);\n      pointCount = pointCount < 2 ? 2 : pointCount; // alternative to this hardcoded version: https://stackoverflow.com/a/18499923/2179399\n    }\n\n    if (curve instanceof rhino.NurbsCurve && curve.degree === 1) {\n      const pLine = curve.tryGetPolyline();\n\n      for (let i = 0; i < pLine.count; i++) {\n        rc.push(pLine.get(i));\n      }\n\n      pLine.delete();\n      return rc;\n    }\n\n    const domain = curve.domain;\n    const divisions = pointCount - 1.0;\n\n    for (let j = 0; j < pointCount; j++) {\n      const t = domain[0] + j / divisions * (domain[1] - domain[0]);\n\n      if (t === domain[0] || t === domain[1]) {\n        ts.push(t);\n        continue;\n      }\n\n      const tan = curve.tangentAt(t);\n      const prevTan = curve.tangentAt(ts.slice(-1)[0]); // Duplicated from THREE.Vector3\n      // How to pass imports to worker?\n\n      const tS = tan[0] * tan[0] + tan[1] * tan[1] + tan[2] * tan[2];\n      const ptS = prevTan[0] * prevTan[0] + prevTan[1] * prevTan[1] + prevTan[2] * prevTan[2];\n      const denominator = Math.sqrt(tS * ptS);\n      let angle;\n\n      if (denominator === 0) {\n        angle = Math.PI / 2;\n      } else {\n        const theta = (tan.x * prevTan.x + tan.y * prevTan.y + tan.z * prevTan.z) / denominator;\n        angle = Math.acos(Math.max(-1, Math.min(1, theta)));\n      }\n\n      if (angle < 0.1) continue;\n      ts.push(t);\n    }\n\n    rc = ts.map(t => curve.pointAt(t));\n    return rc;\n  }\n}\n\nexport { Rhino3dmLoader };\n"]},"metadata":{},"sourceType":"module"}