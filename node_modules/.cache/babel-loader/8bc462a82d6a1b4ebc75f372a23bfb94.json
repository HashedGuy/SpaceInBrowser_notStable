{"ast":null,"code":"import _slicedToArray from \"/Users/arbus/Documents/SpaceInBrowser/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport _objectWithoutProperties from \"/Users/arbus/Documents/SpaceInBrowser/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js\";\nvar _excluded = [\"mixBlur\", \"mixStrength\", \"resolution\", \"blur\", \"args\", \"minDepthThreshold\", \"maxDepthThreshold\", \"depthScale\", \"depthToBlurRatioBias\", \"mirror\", \"children\", \"debug\", \"distortion\", \"mixContrast\", \"distortionMap\"];\nimport _extends from '@babel/runtime/helpers/esm/extends';\nimport * as React from 'react';\nimport { Plane, Vector3, Matrix4, Vector4, PerspectiveCamera, LinearFilter, WebGLRenderTarget, DepthTexture, DepthFormat, UnsignedShortType } from 'three';\nimport { extend, useThree, useFrame } from '@react-three/fiber';\nimport mergeRefs from 'react-merge-refs';\nimport { BlurPass } from '../materials/BlurPass.js';\nimport { MeshReflectorMaterial } from '../materials/MeshReflectorMaterial.js';\nextend({\n  MeshReflectorMaterial: MeshReflectorMaterial\n});\nvar Reflector = /*#__PURE__*/React.forwardRef(function (_ref, ref) {\n  var _ref$mixBlur = _ref.mixBlur,\n      mixBlur = _ref$mixBlur === void 0 ? 0 : _ref$mixBlur,\n      _ref$mixStrength = _ref.mixStrength,\n      mixStrength = _ref$mixStrength === void 0 ? 0.5 : _ref$mixStrength,\n      _ref$resolution = _ref.resolution,\n      resolution = _ref$resolution === void 0 ? 256 : _ref$resolution,\n      _ref$blur = _ref.blur,\n      blur = _ref$blur === void 0 ? [0, 0] : _ref$blur,\n      _ref$args = _ref.args,\n      args = _ref$args === void 0 ? [1, 1] : _ref$args,\n      _ref$minDepthThreshol = _ref.minDepthThreshold,\n      minDepthThreshold = _ref$minDepthThreshol === void 0 ? 0.9 : _ref$minDepthThreshol,\n      _ref$maxDepthThreshol = _ref.maxDepthThreshold,\n      maxDepthThreshold = _ref$maxDepthThreshol === void 0 ? 1 : _ref$maxDepthThreshol,\n      _ref$depthScale = _ref.depthScale,\n      depthScale = _ref$depthScale === void 0 ? 0 : _ref$depthScale,\n      _ref$depthToBlurRatio = _ref.depthToBlurRatioBias,\n      depthToBlurRatioBias = _ref$depthToBlurRatio === void 0 ? 0.25 : _ref$depthToBlurRatio,\n      _ref$mirror = _ref.mirror,\n      mirror = _ref$mirror === void 0 ? 0 : _ref$mirror,\n      children = _ref.children,\n      _ref$debug = _ref.debug,\n      debug = _ref$debug === void 0 ? 0 : _ref$debug,\n      _ref$distortion = _ref.distortion,\n      distortion = _ref$distortion === void 0 ? 1 : _ref$distortion,\n      _ref$mixContrast = _ref.mixContrast,\n      mixContrast = _ref$mixContrast === void 0 ? 1 : _ref$mixContrast,\n      distortionMap = _ref.distortionMap,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  React.useEffect(function () {\n    console.warn('Reflector has been deprecated and will be removed next major. Replace it with <MeshReflectorMaterial />!');\n  }, []);\n  var gl = useThree(function (_ref2) {\n    var gl = _ref2.gl;\n    return gl;\n  });\n  var camera = useThree(function (_ref3) {\n    var camera = _ref3.camera;\n    return camera;\n  });\n  var scene = useThree(function (_ref4) {\n    var scene = _ref4.scene;\n    return scene;\n  });\n  blur = Array.isArray(blur) ? blur : [blur, blur];\n  var hasBlur = blur[0] + blur[1] > 0;\n  var meshRef = React.useRef(null);\n\n  var _React$useState = React.useState(function () {\n    return new Plane();\n  }),\n      _React$useState2 = _slicedToArray(_React$useState, 1),\n      reflectorPlane = _React$useState2[0];\n\n  var _React$useState3 = React.useState(function () {\n    return new Vector3();\n  }),\n      _React$useState4 = _slicedToArray(_React$useState3, 1),\n      normal = _React$useState4[0];\n\n  var _React$useState5 = React.useState(function () {\n    return new Vector3();\n  }),\n      _React$useState6 = _slicedToArray(_React$useState5, 1),\n      reflectorWorldPosition = _React$useState6[0];\n\n  var _React$useState7 = React.useState(function () {\n    return new Vector3();\n  }),\n      _React$useState8 = _slicedToArray(_React$useState7, 1),\n      cameraWorldPosition = _React$useState8[0];\n\n  var _React$useState9 = React.useState(function () {\n    return new Matrix4();\n  }),\n      _React$useState10 = _slicedToArray(_React$useState9, 1),\n      rotationMatrix = _React$useState10[0];\n\n  var _React$useState11 = React.useState(function () {\n    return new Vector3(0, 0, -1);\n  }),\n      _React$useState12 = _slicedToArray(_React$useState11, 1),\n      lookAtPosition = _React$useState12[0];\n\n  var _React$useState13 = React.useState(function () {\n    return new Vector4();\n  }),\n      _React$useState14 = _slicedToArray(_React$useState13, 1),\n      clipPlane = _React$useState14[0];\n\n  var _React$useState15 = React.useState(function () {\n    return new Vector3();\n  }),\n      _React$useState16 = _slicedToArray(_React$useState15, 1),\n      view = _React$useState16[0];\n\n  var _React$useState17 = React.useState(function () {\n    return new Vector3();\n  }),\n      _React$useState18 = _slicedToArray(_React$useState17, 1),\n      target = _React$useState18[0];\n\n  var _React$useState19 = React.useState(function () {\n    return new Vector4();\n  }),\n      _React$useState20 = _slicedToArray(_React$useState19, 1),\n      q = _React$useState20[0];\n\n  var _React$useState21 = React.useState(function () {\n    return new Matrix4();\n  }),\n      _React$useState22 = _slicedToArray(_React$useState21, 1),\n      textureMatrix = _React$useState22[0];\n\n  var _React$useState23 = React.useState(function () {\n    return new PerspectiveCamera();\n  }),\n      _React$useState24 = _slicedToArray(_React$useState23, 1),\n      virtualCamera = _React$useState24[0];\n\n  var beforeRender = React.useCallback(function () {\n    reflectorWorldPosition.setFromMatrixPosition(meshRef.current.matrixWorld);\n    cameraWorldPosition.setFromMatrixPosition(camera.matrixWorld);\n    rotationMatrix.extractRotation(meshRef.current.matrixWorld);\n    normal.set(0, 0, 1);\n    normal.applyMatrix4(rotationMatrix);\n    view.subVectors(reflectorWorldPosition, cameraWorldPosition); // Avoid rendering when reflector is facing away\n\n    if (view.dot(normal) > 0) return;\n    view.reflect(normal).negate();\n    view.add(reflectorWorldPosition);\n    rotationMatrix.extractRotation(camera.matrixWorld);\n    lookAtPosition.set(0, 0, -1);\n    lookAtPosition.applyMatrix4(rotationMatrix);\n    lookAtPosition.add(cameraWorldPosition);\n    target.subVectors(reflectorWorldPosition, lookAtPosition);\n    target.reflect(normal).negate();\n    target.add(reflectorWorldPosition);\n    virtualCamera.position.copy(view);\n    virtualCamera.up.set(0, 1, 0);\n    virtualCamera.up.applyMatrix4(rotationMatrix);\n    virtualCamera.up.reflect(normal);\n    virtualCamera.lookAt(target);\n    virtualCamera.far = camera.far; // Used in WebGLBackground\n\n    virtualCamera.updateMatrixWorld();\n    virtualCamera.projectionMatrix.copy(camera.projectionMatrix); // Update the texture matrix\n\n    textureMatrix.set(0.5, 0.0, 0.0, 0.5, 0.0, 0.5, 0.0, 0.5, 0.0, 0.0, 0.5, 0.5, 0.0, 0.0, 0.0, 1.0);\n    textureMatrix.multiply(virtualCamera.projectionMatrix);\n    textureMatrix.multiply(virtualCamera.matrixWorldInverse);\n    textureMatrix.multiply(meshRef.current.matrixWorld); // Now update projection matrix with new clip plane, implementing code from: http://www.terathon.com/code/oblique.html\n    // Paper explaining this technique: http://www.terathon.com/lengyel/Lengyel-Oblique.pdf\n\n    reflectorPlane.setFromNormalAndCoplanarPoint(normal, reflectorWorldPosition);\n    reflectorPlane.applyMatrix4(virtualCamera.matrixWorldInverse);\n    clipPlane.set(reflectorPlane.normal.x, reflectorPlane.normal.y, reflectorPlane.normal.z, reflectorPlane.constant);\n    var projectionMatrix = virtualCamera.projectionMatrix;\n    q.x = (Math.sign(clipPlane.x) + projectionMatrix.elements[8]) / projectionMatrix.elements[0];\n    q.y = (Math.sign(clipPlane.y) + projectionMatrix.elements[9]) / projectionMatrix.elements[5];\n    q.z = -1.0;\n    q.w = (1.0 + projectionMatrix.elements[10]) / projectionMatrix.elements[14]; // Calculate the scaled plane vector\n\n    clipPlane.multiplyScalar(2.0 / clipPlane.dot(q)); // Replacing the third row of the projection matrix\n\n    projectionMatrix.elements[2] = clipPlane.x;\n    projectionMatrix.elements[6] = clipPlane.y;\n    projectionMatrix.elements[10] = clipPlane.z + 1.0;\n    projectionMatrix.elements[14] = clipPlane.w;\n  }, []);\n\n  var _React$useMemo = React.useMemo(function () {\n    var parameters = {\n      minFilter: LinearFilter,\n      magFilter: LinearFilter,\n      encoding: gl.outputEncoding\n    };\n    var fbo1 = new WebGLRenderTarget(resolution, resolution, parameters);\n    fbo1.depthBuffer = true;\n    fbo1.depthTexture = new DepthTexture(resolution, resolution);\n    fbo1.depthTexture.format = DepthFormat;\n    fbo1.depthTexture.type = UnsignedShortType;\n    var fbo2 = new WebGLRenderTarget(resolution, resolution, parameters);\n    var blurpass = new BlurPass({\n      gl: gl,\n      resolution: resolution,\n      width: blur[0],\n      height: blur[1],\n      minDepthThreshold: minDepthThreshold,\n      maxDepthThreshold: maxDepthThreshold,\n      depthScale: depthScale,\n      depthToBlurRatioBias: depthToBlurRatioBias\n    });\n    var reflectorProps = {\n      mirror: mirror,\n      textureMatrix: textureMatrix,\n      mixBlur: mixBlur,\n      tDiffuse: fbo1.texture,\n      tDepth: fbo1.depthTexture,\n      tDiffuseBlur: fbo2.texture,\n      hasBlur: hasBlur,\n      mixStrength: mixStrength,\n      minDepthThreshold: minDepthThreshold,\n      maxDepthThreshold: maxDepthThreshold,\n      depthScale: depthScale,\n      depthToBlurRatioBias: depthToBlurRatioBias,\n      transparent: true,\n      debug: debug,\n      distortion: distortion,\n      distortionMap: distortionMap,\n      mixContrast: mixContrast,\n      'defines-USE_BLUR': hasBlur ? '' : undefined,\n      'defines-USE_DEPTH': depthScale > 0 ? '' : undefined,\n      'defines-USE_DISTORTION': distortionMap ? '' : undefined\n    };\n    return [fbo1, fbo2, blurpass, reflectorProps];\n  }, [gl, blur, textureMatrix, resolution, mirror, hasBlur, mixBlur, mixStrength, minDepthThreshold, maxDepthThreshold, depthScale, depthToBlurRatioBias, debug, distortion, distortionMap, mixContrast]),\n      _React$useMemo2 = _slicedToArray(_React$useMemo, 4),\n      fbo1 = _React$useMemo2[0],\n      fbo2 = _React$useMemo2[1],\n      blurpass = _React$useMemo2[2],\n      reflectorProps = _React$useMemo2[3];\n\n  useFrame(function () {\n    if (!(meshRef != null && meshRef.current)) return;\n    meshRef.current.visible = false;\n    var currentXrEnabled = gl.xr.enabled;\n    var currentShadowAutoUpdate = gl.shadowMap.autoUpdate;\n    beforeRender();\n    gl.xr.enabled = false;\n    gl.shadowMap.autoUpdate = false;\n    gl.setRenderTarget(fbo1);\n    gl.state.buffers.depth.setMask(true);\n    if (!gl.autoClear) gl.clear();\n    gl.render(scene, virtualCamera);\n    if (hasBlur) blurpass.render(gl, fbo1, fbo2);\n    gl.xr.enabled = currentXrEnabled;\n    gl.shadowMap.autoUpdate = currentShadowAutoUpdate;\n    meshRef.current.visible = true;\n    gl.setRenderTarget(null);\n  });\n  return /*#__PURE__*/React.createElement(\"mesh\", _extends({\n    ref: mergeRefs([meshRef, ref])\n  }, props), /*#__PURE__*/React.createElement(\"planeBufferGeometry\", {\n    args: args\n  }), children ? children('meshReflectorMaterial', reflectorProps) : /*#__PURE__*/React.createElement(\"meshReflectorMaterial\", reflectorProps));\n});\nexport { Reflector };","map":{"version":3,"sources":["/Users/arbus/Documents/SpaceInBrowser/node_modules/@react-three/drei/core/Reflector.js"],"names":["_extends","React","Plane","Vector3","Matrix4","Vector4","PerspectiveCamera","LinearFilter","WebGLRenderTarget","DepthTexture","DepthFormat","UnsignedShortType","extend","useThree","useFrame","mergeRefs","BlurPass","MeshReflectorMaterial","Reflector","forwardRef","ref","mixBlur","mixStrength","resolution","blur","args","minDepthThreshold","maxDepthThreshold","depthScale","depthToBlurRatioBias","mirror","children","debug","distortion","mixContrast","distortionMap","props","useEffect","console","warn","gl","camera","scene","Array","isArray","hasBlur","meshRef","useRef","useState","reflectorPlane","normal","reflectorWorldPosition","cameraWorldPosition","rotationMatrix","lookAtPosition","clipPlane","view","target","q","textureMatrix","virtualCamera","beforeRender","useCallback","setFromMatrixPosition","current","matrixWorld","extractRotation","set","applyMatrix4","subVectors","dot","reflect","negate","add","position","copy","up","lookAt","far","updateMatrixWorld","projectionMatrix","multiply","matrixWorldInverse","setFromNormalAndCoplanarPoint","x","y","z","constant","Math","sign","elements","w","multiplyScalar","useMemo","parameters","minFilter","magFilter","encoding","outputEncoding","fbo1","depthBuffer","depthTexture","format","type","fbo2","blurpass","width","height","reflectorProps","tDiffuse","texture","tDepth","tDiffuseBlur","transparent","undefined","visible","currentXrEnabled","xr","enabled","currentShadowAutoUpdate","shadowMap","autoUpdate","setRenderTarget","state","buffers","depth","setMask","autoClear","clear","render","createElement"],"mappings":"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","sourcesContent":["import _extends from '@babel/runtime/helpers/esm/extends';\nimport * as React from 'react';\nimport { Plane, Vector3, Matrix4, Vector4, PerspectiveCamera, LinearFilter, WebGLRenderTarget, DepthTexture, DepthFormat, UnsignedShortType } from 'three';\nimport { extend, useThree, useFrame } from '@react-three/fiber';\nimport mergeRefs from 'react-merge-refs';\nimport { BlurPass } from '../materials/BlurPass.js';\nimport { MeshReflectorMaterial } from '../materials/MeshReflectorMaterial.js';\n\nextend({\n  MeshReflectorMaterial\n});\nconst Reflector = /*#__PURE__*/React.forwardRef(({\n  mixBlur = 0,\n  mixStrength = 0.5,\n  resolution = 256,\n  blur = [0, 0],\n  args = [1, 1],\n  minDepthThreshold = 0.9,\n  maxDepthThreshold = 1,\n  depthScale = 0,\n  depthToBlurRatioBias = 0.25,\n  mirror = 0,\n  children,\n  debug = 0,\n  distortion = 1,\n  mixContrast = 1,\n  distortionMap,\n  ...props\n}, ref) => {\n  React.useEffect(() => {\n    console.warn('Reflector has been deprecated and will be removed next major. Replace it with <MeshReflectorMaterial />!');\n  }, []);\n  const gl = useThree(({\n    gl\n  }) => gl);\n  const camera = useThree(({\n    camera\n  }) => camera);\n  const scene = useThree(({\n    scene\n  }) => scene);\n  blur = Array.isArray(blur) ? blur : [blur, blur];\n  const hasBlur = blur[0] + blur[1] > 0;\n  const meshRef = React.useRef(null);\n  const [reflectorPlane] = React.useState(() => new Plane());\n  const [normal] = React.useState(() => new Vector3());\n  const [reflectorWorldPosition] = React.useState(() => new Vector3());\n  const [cameraWorldPosition] = React.useState(() => new Vector3());\n  const [rotationMatrix] = React.useState(() => new Matrix4());\n  const [lookAtPosition] = React.useState(() => new Vector3(0, 0, -1));\n  const [clipPlane] = React.useState(() => new Vector4());\n  const [view] = React.useState(() => new Vector3());\n  const [target] = React.useState(() => new Vector3());\n  const [q] = React.useState(() => new Vector4());\n  const [textureMatrix] = React.useState(() => new Matrix4());\n  const [virtualCamera] = React.useState(() => new PerspectiveCamera());\n  const beforeRender = React.useCallback(() => {\n    reflectorWorldPosition.setFromMatrixPosition(meshRef.current.matrixWorld);\n    cameraWorldPosition.setFromMatrixPosition(camera.matrixWorld);\n    rotationMatrix.extractRotation(meshRef.current.matrixWorld);\n    normal.set(0, 0, 1);\n    normal.applyMatrix4(rotationMatrix);\n    view.subVectors(reflectorWorldPosition, cameraWorldPosition); // Avoid rendering when reflector is facing away\n\n    if (view.dot(normal) > 0) return;\n    view.reflect(normal).negate();\n    view.add(reflectorWorldPosition);\n    rotationMatrix.extractRotation(camera.matrixWorld);\n    lookAtPosition.set(0, 0, -1);\n    lookAtPosition.applyMatrix4(rotationMatrix);\n    lookAtPosition.add(cameraWorldPosition);\n    target.subVectors(reflectorWorldPosition, lookAtPosition);\n    target.reflect(normal).negate();\n    target.add(reflectorWorldPosition);\n    virtualCamera.position.copy(view);\n    virtualCamera.up.set(0, 1, 0);\n    virtualCamera.up.applyMatrix4(rotationMatrix);\n    virtualCamera.up.reflect(normal);\n    virtualCamera.lookAt(target);\n    virtualCamera.far = camera.far; // Used in WebGLBackground\n\n    virtualCamera.updateMatrixWorld();\n    virtualCamera.projectionMatrix.copy(camera.projectionMatrix); // Update the texture matrix\n\n    textureMatrix.set(0.5, 0.0, 0.0, 0.5, 0.0, 0.5, 0.0, 0.5, 0.0, 0.0, 0.5, 0.5, 0.0, 0.0, 0.0, 1.0);\n    textureMatrix.multiply(virtualCamera.projectionMatrix);\n    textureMatrix.multiply(virtualCamera.matrixWorldInverse);\n    textureMatrix.multiply(meshRef.current.matrixWorld); // Now update projection matrix with new clip plane, implementing code from: http://www.terathon.com/code/oblique.html\n    // Paper explaining this technique: http://www.terathon.com/lengyel/Lengyel-Oblique.pdf\n\n    reflectorPlane.setFromNormalAndCoplanarPoint(normal, reflectorWorldPosition);\n    reflectorPlane.applyMatrix4(virtualCamera.matrixWorldInverse);\n    clipPlane.set(reflectorPlane.normal.x, reflectorPlane.normal.y, reflectorPlane.normal.z, reflectorPlane.constant);\n    const projectionMatrix = virtualCamera.projectionMatrix;\n    q.x = (Math.sign(clipPlane.x) + projectionMatrix.elements[8]) / projectionMatrix.elements[0];\n    q.y = (Math.sign(clipPlane.y) + projectionMatrix.elements[9]) / projectionMatrix.elements[5];\n    q.z = -1.0;\n    q.w = (1.0 + projectionMatrix.elements[10]) / projectionMatrix.elements[14]; // Calculate the scaled plane vector\n\n    clipPlane.multiplyScalar(2.0 / clipPlane.dot(q)); // Replacing the third row of the projection matrix\n\n    projectionMatrix.elements[2] = clipPlane.x;\n    projectionMatrix.elements[6] = clipPlane.y;\n    projectionMatrix.elements[10] = clipPlane.z + 1.0;\n    projectionMatrix.elements[14] = clipPlane.w;\n  }, []);\n  const [fbo1, fbo2, blurpass, reflectorProps] = React.useMemo(() => {\n    const parameters = {\n      minFilter: LinearFilter,\n      magFilter: LinearFilter,\n      encoding: gl.outputEncoding\n    };\n    const fbo1 = new WebGLRenderTarget(resolution, resolution, parameters);\n    fbo1.depthBuffer = true;\n    fbo1.depthTexture = new DepthTexture(resolution, resolution);\n    fbo1.depthTexture.format = DepthFormat;\n    fbo1.depthTexture.type = UnsignedShortType;\n    const fbo2 = new WebGLRenderTarget(resolution, resolution, parameters);\n    const blurpass = new BlurPass({\n      gl,\n      resolution,\n      width: blur[0],\n      height: blur[1],\n      minDepthThreshold,\n      maxDepthThreshold,\n      depthScale,\n      depthToBlurRatioBias\n    });\n    const reflectorProps = {\n      mirror,\n      textureMatrix,\n      mixBlur,\n      tDiffuse: fbo1.texture,\n      tDepth: fbo1.depthTexture,\n      tDiffuseBlur: fbo2.texture,\n      hasBlur,\n      mixStrength,\n      minDepthThreshold,\n      maxDepthThreshold,\n      depthScale,\n      depthToBlurRatioBias,\n      transparent: true,\n      debug,\n      distortion,\n      distortionMap,\n      mixContrast,\n      'defines-USE_BLUR': hasBlur ? '' : undefined,\n      'defines-USE_DEPTH': depthScale > 0 ? '' : undefined,\n      'defines-USE_DISTORTION': distortionMap ? '' : undefined\n    };\n    return [fbo1, fbo2, blurpass, reflectorProps];\n  }, [gl, blur, textureMatrix, resolution, mirror, hasBlur, mixBlur, mixStrength, minDepthThreshold, maxDepthThreshold, depthScale, depthToBlurRatioBias, debug, distortion, distortionMap, mixContrast]);\n  useFrame(() => {\n    if (!(meshRef != null && meshRef.current)) return;\n    meshRef.current.visible = false;\n    const currentXrEnabled = gl.xr.enabled;\n    const currentShadowAutoUpdate = gl.shadowMap.autoUpdate;\n    beforeRender();\n    gl.xr.enabled = false;\n    gl.shadowMap.autoUpdate = false;\n    gl.setRenderTarget(fbo1);\n    gl.state.buffers.depth.setMask(true);\n    if (!gl.autoClear) gl.clear();\n    gl.render(scene, virtualCamera);\n    if (hasBlur) blurpass.render(gl, fbo1, fbo2);\n    gl.xr.enabled = currentXrEnabled;\n    gl.shadowMap.autoUpdate = currentShadowAutoUpdate;\n    meshRef.current.visible = true;\n    gl.setRenderTarget(null);\n  });\n  return /*#__PURE__*/React.createElement(\"mesh\", _extends({\n    ref: mergeRefs([meshRef, ref])\n  }, props), /*#__PURE__*/React.createElement(\"planeBufferGeometry\", {\n    args: args\n  }), children ? children('meshReflectorMaterial', reflectorProps) : /*#__PURE__*/React.createElement(\"meshReflectorMaterial\", reflectorProps));\n});\n\nexport { Reflector };\n"]},"metadata":{},"sourceType":"module"}